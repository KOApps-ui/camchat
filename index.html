<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Permissions-Policy" content="camera=*, microphone=*, display-capture=*, fullscreen=*">
    <title>G√∂r√ºnt√ºl√º Sohbet</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200');
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        :root {
            /* Ana Renkler - Premium Palet */
            --primary: #7C3AED;
            --primary-light: #A78BFA;
            --primary-dark: #5B21B6;
            --secondary: #EC4899;
            --secondary-light: #F472B6;
            --accent: #06B6D4;
            --accent-light: #22D3EE;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;

            /* Arka Planlar - Geli≈ümi≈ü Glassmorphism */
            --bg-primary: #0F172A;
            --bg-secondary: #1E293B;
            --bg-tertiary: #334155;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.18);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);

            /* Gradients - Premium */
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-accent: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-dark: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);

            /* Metin */
            --text-primary: #F8FAFC;
            --text-secondary: #CBD5E1;
            --text-muted: #94A3B8;

            /* Diƒüer */
            --border-color: rgba(255, 255, 255, 0.12);
            --radius: 16px;
            --radius-sm: 8px;
            --radius-lg: 24px;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.4);
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s ease;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background: var(--bg-primary);
            background-image: radial-gradient(circle at 20% 50%, rgba(124, 58, 237, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(236, 72, 153, 0.15) 0%, transparent 50%),
                linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #0F172A 100%);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .material-symbols-rounded {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 48;
            vertical-align: middle;
            font-size: 1.2em;
        }

        #join-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: rgba(30, 30, 50, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 3rem;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(100, 100, 150, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 420px;
            width: 90%;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-content h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #4A9EFF;
            margin: 0 0 0.5rem 0;
        }

        .modal-content p {
            color: #8B9DC3;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        .modal-content h1::before {
            content: 'videocam';
            font-family: 'Material Symbols Rounded';
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            background: linear-gradient(135deg, #4A9EFF 0%, #2D7FE8 100%);
            color: white;
            border-radius: 50%;
            width: 90px;
            height: 90px;
            margin: 0 auto 1.5rem;
            box-shadow: 0 8px 24px rgba(74, 158, 255, 0.4);
            animation: pulse 2s infinite;
        }

        .modal-content input {
            display: block;
            width: 100%;
            padding: 16px;
            margin-top: 1rem;
            border: 2px solid rgba(74, 158, 255, 0.3);
            border-radius: 12px;
            background: rgba(20, 20, 40, 0.6);
            color: white;
            font-size: 1.1rem;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .modal-content input:focus {
            outline: none;
            border-color: #4A9EFF;
            background: rgba(20, 20, 40, 0.8);
            box-shadow: 0 0 0 4px rgba(74, 158, 255, 0.15);
        }

        .modal-content input::placeholder {
            color: rgba(139, 157, 195, 0.6);
        }

        .modal-content button {
            width: 100%;
            padding: 18px;
            margin-top: 2rem;
            background: linear-gradient(135deg, #4A9EFF 0%, #2D7FE8 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(74, 158, 255, 0.4);
            text-transform: none;
        }

        .modal-content button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 28px rgba(74, 158, 255, 0.6);
            background: linear-gradient(135deg, #5AADFF 0%, #3D8FF8 100%);
        }

        .modal-content button:active {
            transform: translateY(0);
        }

        #call-wrapper {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
        }

        #main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        #main-stage {
            flex: 1;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        #main-stage-placeholder {
            font-size: 1.5rem;
            color: #888;
        }

        .video-box {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            transition: box-shadow 0.2s;
        }

        .video-mirrored {
            transform: scaleX(-1) !important;
        }

        #ring-light {
            position: absolute;
            width: 300px;
            height: 300px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 100px 50px white;
            z-index: 1000;
            cursor: move;
            display: none;
            opacity: 0.95;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            /* Merkezleme i√ßin kritik */
            pointer-events: auto;
            user-select: none;
        }

        #ring-size-slider {
            position: absolute;
            bottom: -50px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            cursor: pointer;
            z-index: 1001;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
        }

        #ring-light::after {
            content: 'Aydƒ±nlatƒ±cƒ±';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ddd;
            font-weight: bold;
            font-size: 0.8rem;
            pointer-events: none;
        }

        .video-box video {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            object-fit: contain;
            transition: filter 0.3s;
        }

        .video-box .username-label {
            position: absolute;
            bottom: 10px;
            left: 15px;
            margin: 0;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            z-index: 10;
        }

        /* INFO STRIP */
        .info-strip {
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            padding: 6px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            position: absolute;
            bottom: 0;
            left: 0;
            box-sizing: border-box;
            z-index: 10;
        }

        .info-strip .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-strip .username {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .info-strip .indicators {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* AUDIO METER (SES BARI) */
        .audio-meter {
            width: 4px;
            height: 16px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
            display: inline-block;
            position: relative;
        }

        .audio-meter-fill {
            width: 100%;
            height: 0%;
            background: #00e676;
            position: absolute;
            bottom: 0;
            left: 0;
            transition: height 0.1s;
        }

        .mic-indicator {
            font-size: 16px;
            color: white;
            transition: color 0.2s;
        }

        .mic-indicator.muted {
            color: #ff1744;
        }

        /* SIGNAL BARS */
        .signal-bars {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 12px;
            width: 16px;
        }

        /* VOLUME CONTROL */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-right: 8px;
        }

        .volume-slider {
            width: 0;
            height: 20px;
            overflow: hidden;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), margin 0.3s;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
            margin: 0;
            padding: 0;
        }

        .volume-control:hover .volume-slider {
            width: 60px;
            margin: 0 4px;
        }

        .volume-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #fff;
            margin-top: -4px;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
        }

        /* √áer√ßeve I≈üƒ±ƒüƒ± (Frame Light) */
        #frame-light {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 9999;
            border: 0px solid rgba(255, 255, 255, 0.9);
            box-sizing: border-box;
            display: none;
            transition: border-width 0.2s ease, border-color 0.2s ease;

        }

        #frame-light-controls {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            flex-direction: column;
            align-items: center;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            z-index: 10000;
            gap: 10px;
            min-width: 250px;

            /* Auto-hide √∂zelliƒüi i√ßin */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #frame-light-controls.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #frame-light-controls label {
            color: #fff;
            font-size: 0.85rem;
            margin-bottom: 2px;
            font-weight: 500;
        }

        #frame-light-controls input[type=range] {
            width: 100%;
            cursor: pointer;
        }

        .signal-bar {
            width: 3px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 1px;
        }

        .signal-bar:nth-child(1) {
            height: 3px;
        }

        .signal-bar:nth-child(2) {
            height: 6px;
        }

        .signal-bar:nth-child(3) {
            height: 9px;
        }

        .signal-bar:nth-child(4) {
            height: 12px;
        }

        .signal-good .signal-bar {
            background: #00e676;
        }

        .signal-fair .signal-bar:nth-child(1),
        .signal-fair .signal-bar:nth-child(2),
        .signal-fair .signal-bar:nth-child(3) {
            background: #ffeb3b;
        }

        .signal-poor .signal-bar:nth-child(1),
        .signal-poor .signal-bar:nth-child(2) {
            background: #ff1744;
        }

        .bandwidth-warning {
            display: none;
            color: #ff1744;
            font-size: 1.2rem;
            margin-right: 5px;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.5;
            }
        }

        /* SIDEBAR & RESIZER */
        #participant-gallery {
            width: 280px;
            min-width: 200px;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--glass-border);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #participant-gallery.hidden {
            width: 0 !important;
            min-width: 0 !important;
            overflow: hidden;
            border-left: none;
        }

        #resizer {
            width: 10px;
            background: rgba(0, 0, 0, 0.2);
            cursor: col-resize;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            border-left: 1px solid rgba(255, 255, 255, 0.05);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
        }

        #resizer:hover,
        #resizer.resizing {
            background: var(--primary-color);
        }

        #resizer::after {
            content: '||';
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        #gallery-header {
            padding: 15px;
            font-size: 1.1rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.2);
        }

        #timer-display {
            font-family: monospace;
            font-weight: bold;
            letter-spacing: 1px;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        #gallery-list {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        /* GALLERY ITEM */
        .gallery-item {
            position: relative;
            aspect-ratio: 16 / 9;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-sm);
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-direction: column;
        }

        .gallery-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-light);
        }

        .gallery-item.main-display {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.5);
        }

        .gallery-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            z-index: 1;
            top: 0;
            left: 0;
            transition: filter 0.3s;
        }

        .gallery-item .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            z-index: 2;
            display: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .gallery-item.no-video .avatar {
            display: block;
        }

        /* GALERI INFO STRIP (Isim Gizli, Ikonlar Acik) */
        #gallery-list .info-strip {
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.6);
            justify-content: space-between;
        }

        #gallery-list .info-strip .username {
            display: none !important;
        }

        #gallery-list .info-strip .indicators {
            margin-left: auto;
        }

        /* CAMERA VISIBILITY */
        .gallery-item.camera-off {
            opacity: 0;
            width: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden;
            pointer-events: none;
            border: none !important;
            min-width: 0 !important;
            transform: scale(0);
        }

        #control-bar {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 20px 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            border-top: 1px solid var(--glass-border);
            z-index: 50;
            position: relative;
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.2);
        }

        .control-button {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 16px;
            border-radius: 50%;
            width: 64px;
            height: 64px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: var(--transition);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-sm);
        }

        .control-button::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: -1;
        }

        .control-button:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-light);
        }

        .control-button:hover::before {
            opacity: 0.1;
        }

        .control-button .material-symbols-rounded {
            font-size: 28px;
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .control-button:hover .material-symbols-rounded {
            transform: scale(1.15) rotate(5deg);
        }

        .control-button.active {
            background: var(--gradient-primary);
            border: none;
            color: white;
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4);
        }

        .control-button.active::before {
            opacity: 0;
        }

        .control-button.danger {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            border: none;
            color: white;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
        }

        .control-button.danger:hover {
            box-shadow: 0 6px 28px rgba(239, 68, 68, 0.6);
        }

        #pip-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 60;
            display: none;
        }

        #pip-button:hover {
            background: var(--primary-color);
        }

        #chat-panel {
            position: fixed;
            bottom: 95px;
            right: 20px;
            width: 420px;
            max-height: 60vh;
            z-index: 150;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        #chat-panel:not(.hidden) {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        #chat-header {
            padding: 15px;
            font-size: 1.1rem;
            border-bottom: 1px solid var(--border-color);
        }

        #chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-message {
            display: flex;
            flex-direction: column;
            max-width: 85%;
        }

        .chat-message .sender {
            font-size: 0.8rem;
            margin-bottom: 4px;
            color: var(--primary-color);
        }

        .chat-message .content {
            padding: 8px 12px;
            border-radius: 10px;
            word-break: break-word;
        }

        .chat-message.local {
            align-self: flex-end;
        }

        .chat-message.local .content {
            background-color: var(--primary-color);
            color: white;
        }

        .chat-message.remote {
            align-self: flex-start;
        }

        .chat-message.remote .content {
            background-color: var(--card-color);
        }

        .chat-message.file .content {
            background: transparent;
            border: 1px solid var(--primary-color);
        }

        .file-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            text-decoration: none;
            color: white;
        }

        .file-preview img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
        }

        .file-preview .file-icon {
            font-size: 32px;
        }

        .file-info {
            display: flex;
            flex-direction: column;
        }

        .file-name {
            font-weight: bold;
            font-size: 0.9rem;
        }

        .file-size {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .progress-container {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            margin-top: 5px;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.2s;
        }

        #chat-input-area {
            display: flex;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            gap: 10px;
            align-items: center;
            height: 70px;
            box-sizing: border-box;
        }

        #chat-input {
            flex: 1;
            padding: 0 15px;
            height: 42px;
            border-radius: 21px;
            background: var(--card-color);
            color: var(--text-dark);
            border: 1px solid var(--border-color);
            box-sizing: border-box;
        }

        #chat-send-button,
        #file-share-btn,
        #poll-create-btn {
            background: var(--primary-color);
            border: none;
            color: white;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        #file-share-btn,
        #poll-create-btn {
            background: var(--card-color);
            border: 1px solid var(--border-color);
        }

        /* SETTINGS */
        #settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease;
        }

        #settings-modal .modal-content {
            text-align: left;
            max-width: 700px;
            width: 90%;
            height: 70vh;
            min-height: 450px;
            display: flex;
            flex-direction: row;
            padding: 0;
            overflow: hidden;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .settings-sidebar {
            width: 200px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
        }

        .settings-sidebar h2 {
            font-size: 1.3rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin: 0 0 25px 0;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--glass-border);
        }

        .tab-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 16px 20px;
            text-align: left;
            cursor: pointer;
            font-size: 1rem;
            transition: var(--transition);
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            border-left-color: var(--primary-light);
        }

        .tab-btn.active {
            background: linear-gradient(90deg, rgba(124, 58, 237, 0.25) 0%, transparent 100%);
            color: var(--primary-light);
            border-left-color: var(--primary);
            font-weight: 600;
        }

        .settings-body {
            flex: 1;
            padding: 35px;
            overflow-y: auto;
            position: relative;
            background: rgba(0, 0, 0, 0.1);
        }

        .settings-body::-webkit-scrollbar {
            width: 8px;
        }

        .settings-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .settings-body::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        .settings-body::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pfp-container {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 1rem auto;
        }

        #pfp-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
        }

        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-section h3 {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            color: var(--primary-color);
        }

        .settings-section select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: white;
            border-radius: 8px;
            margin-top: 5px;
            font-size: 0.95rem;
        }

        /* FILTER GRID REMOVED */

        .switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary-color);
        }

        input:checked+.slider:before {
            transform: translateX(24px);
        }

        #close-settings-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: auto;
            margin: 0;
        }

        #close-settings-button:hover {
            color: white;
        }

        #poll-modal-content {
            text-align: left;
            display: block;
            height: auto;
            width: 400px;
        }

        .poll-option-input {
            margin-top: 10px !important;
        }

        #active-poll-display {
            position: absolute;
            top: 60px;
            right: 20px;
            width: 300px;
            background: rgba(40, 26, 61, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--primary-color);
            z-index: 100;
            display: none;
            color: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .poll-bar-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            height: 20px;
            margin-top: 5px;
            overflow: hidden;
            position: relative;
        }

        .poll-bar {
            height: 100%;
            background: var(--primary-gradient);
            width: 0%;
            transition: width 0.5s;
        }

        .poll-option {
            margin-bottom: 10px;
            cursor: pointer;
        }

        .poll-option:hover .poll-bar-container {
            border: 1px solid var(--primary-color);
        }

        #emoji-panel {
            position: absolute;
            bottom: 85px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(40, 26, 61, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px;
            border-radius: 12px;
            display: flex;
            gap: 10px;
            border: 1px solid var(--border-color);
            z-index: 140;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s;
            flex-wrap: wrap;
            max-width: 90vw;
            justify-content: center;
        }

        #emoji-panel.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(-50%) translateY(-10px);
        }

        .emoji-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            transition: transform 0.2s;
            padding: 5px;
        }

        .emoji-btn:hover {
            transform: scale(1.3);
        }

        .emoji-particle {
            position: absolute;
            bottom: 50px;
            left: 50%;
            font-size: 4.5rem;
            pointer-events: none;
            z-index: 1000;
            animation: particleAnim 3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            opacity: 0;
        }

        @keyframes particleAnim {
            0% {
                transform: translate(-50%, 0) scale(0.5);
                opacity: 1;
            }

            50% {
                opacity: 1;
            }

            100% {
                transform: translate(var(--tx), var(--ty)) rotate(var(--rot)) scale(1.5);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            #main-container {
                flex-direction: column;
            }

            #participant-gallery {
                width: 100%;
                height: 100px;
                min-height: 100px;
                flex-direction: row;
            }

            #resizer {
                width: 100%;
                height: 10px;
                cursor: row-resize;
                border-left: none;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }

            #resizer::after {
                content: '==';
                transform: rotate(90deg);
            }

            #gallery-header {
                display: none;
            }

            #gallery-list {
                flex-direction: row;
                gap: 8px;
            }

            .gallery-item {
                min-width: 140px;
            }

            #chat-panel {
                width: 90%;
                right: 5%;
                bottom: 80px;
            }

            #settings-modal .modal-content {
                flex-direction: column;
                height: 90%;
            }

            .settings-sidebar {
                width: 100%;
                height: auto;
                flex-direction: row;
                overflow-x: auto;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding: 0;
            }

            .tab-btn {
                flex: 0 0 auto;
                padding: 15px;
                border-left: none;
                border-bottom: 3px solid transparent;
            }

            .tab-btn.active {
                border-left: none;
                border-bottom: 3px solid var(--primary-color);
            }
        }
    </style>
</head>

<body>
    <!-- ≈ûƒ∞FRE KORUMASI -->
    <script>
        // ƒ∞STEDƒ∞ƒûƒ∞Nƒ∞Z ≈ûƒ∞FREYƒ∞ BURAYA YAZIN
        const GIZLI_SIFRE = "20052025";

        if (localStorage.getItem("camchat_access") !== "granted") {
            const userInput = prompt("Bu √∂zel odaya girmek i√ßin l√ºtfen ≈üifreyi girin:");
            if (userInput === GIZLI_SIFRE) {
                localStorage.setItem("camchat_access", "granted");
            } else {
                document.body.innerHTML = "<h1 style='color:white; text-align:center; padding-top:20%; font-family:sans-serif;'>Eri≈üim Reddedildi! Yanlƒ±≈ü ≈ûifre.</h1>";
                throw new Error("Eri≈üim Reddedildi - Yanlƒ±≈ü ≈üifre girildi.");
            }
        }
    </script>
    <div id="join-modal">
        <div class="modal-content">
            <h1>G√∂r√ºnt√ºl√º Sohbet</h1>
            <p style="font-size: 0.95rem; color: #4A9EFF; margin-bottom: 1.5rem; font-weight: 500;">Oda: <span
                    id="room-display" style="color: #5AADFF; font-weight: 600;">A≈ükƒ±mƒ±z</span></p>
            <input type="text" id="username-input" name="username" placeholder="Adƒ±nƒ±z" maxlength="20"><button
                id="join-button">Sohbete Ba≈üla</button>
        </div>
    </div>

    <!-- POLL MODAL -->
    <div id="poll-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:250; align-items:center; justify-content:center;">
        <div class="modal-content" id="poll-modal-content">
            <h2 style="margin-top:0;">Anket Olu≈ütur</h2>
            <input type="text" id="poll-question" placeholder="Soru sor..." style="margin-bottom:10px;">
            <div id="poll-options-container">
                <input type="text" class="poll-option-input" placeholder="Se√ßenek 1">
                <input type="text" class="poll-option-input" placeholder="Se√ßenek 2">
            </div>
            <button onclick="addPollOption()" style="margin-top:5px; font-size:0.8rem; padding:5px;">+ Se√ßenek
                Ekle</button>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="startPoll()">Ba≈ülat</button>
                <button onclick="$('#poll-modal').style.display='none'" class="danger">ƒ∞ptal</button>
            </div>
        </div>
    </div>

    <!-- ACTIVE POLL DISPLAY -->
    <div id="active-poll-display">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 id="poll-display-q" style="margin:0; font-size:1rem;">Anket Sorusu</h3>
            <button onclick="$('#active-poll-display').style.display='none'"
                style="background:none; border:none; color:white; cursor:pointer;">‚úï</button>
        </div>
        <div id="poll-display-opts"></div>
    </div>

    <div id="call-wrapper">
        <div id="main-container">
            <div id="main-stage">
                <p id="main-stage-placeholder" class="placeholder">Katƒ±lƒ±mcƒ±lar bekleniyor...</p>
                <button id="pip-button" title="Resim ƒ∞√ßinde Resim"><span
                        class="material-symbols-rounded">picture_in_picture_alt</span></button>
            </div>
            <div id="resizer" title="Boyutlandƒ±rmak i√ßin s√ºr√ºkle"></div>
            <div id="participant-gallery">
                <div id="gallery-header">
                    <span id="timer-display">00:00:00</span>
                </div>
                <div id="gallery-list"></div>
            </div>
        </div>

        <div id="emoji-panel">
            <button class="emoji-btn" data-type="heart">‚ù§Ô∏è</button>
            <button class="emoji-btn" data-type="laugh">üòÇ</button>
            <button class="emoji-btn" data-type="wow">üòÆ</button>
            <button class="emoji-btn" data-type="sad">üò¢</button>
            <button class="emoji-btn" data-type="angry">üò°</button>
            <button class="emoji-btn" data-type="like">üëç</button>
            <button class="emoji-btn" data-type="clap">üëè</button>
            <button class="emoji-btn" data-type="rose">üåπ</button>
            <button class="emoji-btn" data-type="kiss">üíã</button>
            <button class="emoji-btn" data-type="fire">üî•</button>
            <button class="emoji-btn" data-type="party">üéâ</button>
        </div>

        <div id="chat-panel" class="hidden">
            <div id="chat-header">Sohbet</div>
            <div id="chat-messages"></div>
            <div id="chat-input-area">
                <button id="file-share-btn" title="Dosya G√∂nder"><span
                        class="material-symbols-rounded">attach_file</span></button>
                <button id="poll-create-btn" title="Anket Ba≈ülat" onclick="$('#poll-modal').style.display='flex'"><span
                        class="material-symbols-rounded">poll</span></button>
                <input type="file" id="hidden-file-input" hidden>
                <input type="text" id="chat-input" name="chat-message" placeholder="Mesaj yaz..."><button
                    id="chat-send-button"><span class="material-symbols-rounded">send</span></button>
            </div>
        </div>
        <div id="control-bar">
            <button class="control-button active" id="cam-button" title="Kamera"><span
                    class="material-symbols-rounded">videocam</span></button>
            <button class="control-button active" id="mic-button" title="Mikrofon"><span
                    class="material-symbols-rounded">mic</span></button>
            <button class="control-button" id="share-button" title="Ekran Payla≈ü"><span
                    class="material-symbols-rounded">screen_share</span></button>

            <button class="control-button" id="emoji-toggle-button" title="ƒ∞fade G√∂nder"><span
                    class="material-symbols-rounded">mood</span></button>

            <button class="control-button" id="toggle-chat-button" title="Sohbet"><span
                    class="material-symbols-rounded">chat</span></button>
            <button class="control-button" id="ring-light-button" title="Halka I≈üƒ±k"><span
                    class="material-symbols-rounded">highlight</span></button>
            <button class="control-button" id="frame-light-button" title="√áer√ßeve I≈üƒ±ƒüƒ±"><span
                    class="material-symbols-rounded">border_outer</span></button>
            <button class="control-button danger" id="hangup-button" title="Ayrƒ±l"><span
                    class="material-symbols-rounded">call_end</span></button>
            <button class="control-button" id="toggle-gallery-button" title="Katƒ±lƒ±mcƒ±lar"><span
                    class="material-symbols-rounded">group</span></button>
            <button class="control-button" id="toggle-fullscreen-button" title="Tam Ekran"><span
                    class="material-symbols-rounded">fullscreen</span></button>
            <button class="control-button" id="settings-button" title="Ayarlar"><span
                    class="material-symbols-rounded">settings</span></button>
            <button id="screenshot-btn" style="display:none;"></button>
        </div>
        <div id="ring-light">
            <input type="range" id="ring-size-slider" min="100" max="800" value="300" title="Boyutu Ayarla">
        </div>
        <div id="frame-light"></div>
        <div id="frame-light-controls">
            <div style="width:100%; text-align:center;">
                <label>√áer√ßeve Kalƒ±nlƒ±ƒüƒ±</label>
                <input type="range" id="frame-width-slider" min="10" max="300" value="50">
            </div>
            <div style="width:100%; text-align:center;">
                <label>Parlaklƒ±k (Opaklƒ±k)</label>
                <input type="range" id="frame-opacity-slider" min="0.1" max="1" step="0.05" value="0.9">
            </div>
        </div>
    </div>
    <div id="toast-container"></div>

    <!-- SETTINGS MODAL (MODERN) -->
    <div id="settings-modal" style="display: none;">
        <div class="modal-content">
            <div class="settings-sidebar">
                <h2>Ayarlar</h2>
                <button class="tab-btn active" onclick="openTab('profile')"><span
                        class="material-symbols-rounded">person</span> Profil</button>
                <button class="tab-btn" onclick="openTab('devices')"><span
                        class="material-symbols-rounded">devices</span> Cihazlar</button>
                <button class="tab-btn" onclick="openTab('general')"><span class="material-symbols-rounded">tune</span>
                    Genel</button>
            </div>

            <div class="settings-body">
                <button id="close-settings-button" onclick="$('#settings-modal').style.display='none'"><span
                        class="material-symbols-rounded">close</span></button>

                <div id="tab-profile" class="tab-content active">
                    <h3 style="margin-top:0;">Profil D√ºzenle</h3>
                    <div class="profile-settings">
                        <div class="pfp-container">
                            <img id="pfp-preview" alt="Profil Resmi">
                            <label for="pfp-upload" class="pfp-upload-label"><span
                                    class="material-symbols-rounded">edit</span></label>
                            <input type="file" id="pfp-upload" name="pfp-file" accept="image/*" style="display: none;">
                        </div>
                        <p>Profil resminizi deƒüi≈ütirmek i√ßin kaleme tƒ±klayƒ±n.</p>
                    </div>
                </div>

                <div id="tab-devices" class="tab-content">
                    <h3 style="margin-top:0;">Cihaz Se√ßimi</h3>
                    <div class="settings-section">
                        <label>Kamera</label>
                        <select id="video-input-select">
                            <option>Varsayƒ±lan</option>
                        </select>
                    </div>
                    <div class="settings-section">
                        <label>Mikrofon</label>
                        <select id="audio-input-select">
                            <option>Varsayƒ±lan</option>
                        </select>
                    </div>
                </div>

                <!-- EFFECTS TAB REMOVED -->

                <div id="tab-general" class="tab-content">
                    <h3 style="margin-top:0;">Genel Ayarlar</h3>
                    <div class="settings-section">
                        <div class="switch-container">
                            <div>
                                <div style="font-weight:600;">Bas-Konu≈ü (PTT)</div>
                                <div style="font-size:0.8rem; color:#aaa;">Mikrofonu a√ßmak i√ßin Bo≈üluk tu≈üuna basƒ±lƒ±
                                    tutun.</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="ptt-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-section">
                        <div class="switch-container">
                            <div>
                                <div style="font-weight:600;">Kamerayƒ± Aynala</div>
                                <div style="font-size:0.8rem; color:#aaa;">Kendi g√∂r√ºnt√ºn√ºz√º ters (aynalƒ±) √ßevirir.
                                </div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="mirror-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h3>Kƒ±sayollar</h3>
                        <div id="shortcuts-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script>
        const $ = (sel) => document.querySelector(sel);
        window.onerror = function (msg, url, line, col, error) {
            console.error("Global Error:", msg, url, line, col, error);
            // alert("Bir hata olu≈ütu: " + msg + "\nSatƒ±r: " + line); // User requested not to show alerts for minor things, but let's log it.
        };
        let localStream, localScreenStream, myId, username, myPfp;
        let peers = {};
        let peerConnections = {};
        let screenPeerConnections = {};
        let remoteStreams = {};
        let iceCandidateQueues = {};
        let peerMuteStates = {};
        let pollingTimer, callTimerInterval;
        let isMicOn = true, isCamOn = true, isSharing = false;
        let mainDisplayId = null;
        let joinTime = 0;
        let incomingFiles = {};
        let currentFilter = 'none';
        let isPttEnabled = false;
        let isSpaceDown = false;

        const urlParams = new URLSearchParams(window.location.search);
        const ROOM_ID = urlParams.get('room') || 'A≈ükƒ±mƒ±z';
        $('#room-display').textContent = ROOM_ID;

        const apiUrl = location.pathname;
        const ICE_SERVERS = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            { urls: 'stun:stun3.l.google.com:19302' },
            { urls: 'stun:stun4.l.google.com:19302' }
            ], iceCandidatePoolSize: 10
        };
        const mediaConstraints = { video: { width: { ideal: 1280 }, height: { ideal: 720 } }, audio: { echoCancellation: true, noiseSuppression: true } };
        const DEFAULT_PFP = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234a2c6a'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E";

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const SoundFX = {
            playTone: (freq, type, duration, vol = 0.1) => {
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime); gain.gain.setValueAtTime(vol, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + duration);
            },
            playNoise: (duration) => {
                const bufferSize = audioCtx.sampleRate * duration; const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate); const data = buffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1; const noise = audioCtx.createBufferSource(); noise.buffer = buffer; const gain = audioCtx.createGain(); gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration); noise.connect(gain); gain.connect(audioCtx.destination); noise.start();
            },
            playHeart: () => SoundFX.playTone(600, 'sine', 0.5, 0.2) & setTimeout(() => SoundFX.playTone(900, 'sine', 0.4, 0.1), 100),
            playAngry: () => SoundFX.playTone(100, 'sawtooth', 0.8, 0.2),
            playClap: () => { for (let i = 0; i < 5; i++) setTimeout(() => SoundFX.playNoise(0.1), i * 40); },
            playKiss: () => { const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.frequency.setValueAtTime(800, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.2); gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.2); },
            playPop: () => SoundFX.playTone(400 + Math.random() * 200, 'sine', 0.1, 0.1)
        };

        // G√º√ßlendirilmi≈ü API - Retry mekanizmasƒ± ile



        async function performJoin(isSilent = false) {
            if (!isSilent) {
                username = $('#username-input').value.trim();
                if (!username) return alert('L√ºtfen bir ad girin.');
                localStorage.setItem('cs_username', username);
            } else { username = localStorage.getItem('cs_username') || 'Anonim'; }
            myPfp = localStorage.getItem('userPfp') || DEFAULT_PFP;

            await getDevices();
            if (!localStream) { try { localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints); } catch (e) { if (!isSilent) alert('Kamera/mikrofon eri≈üimi reddedildi.'); return; } }

            initPeerJS();

            if (!isSilent) {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                $('#join-modal').style.display = 'none'; $('#call-wrapper').style.display = 'flex';
                createParticipant('local', username + ' (Siz)');
                setStreamToElements('local', localStream); updatePeerPfp('local', myPfp);
                document.getElementById(`gallery-item-local`)?.classList.toggle('no-video', !isCamOn);
                switchMainDisplay('local');
                monitorAudioLevel(localStream, 'local'); startCallTimer();
            }
        }
        $('#join-button').onclick = () => performJoin(false);



        // ======= YENI PEERJS ALTYAPISI =======
        const PEER_CONFIG = {
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' }
                ]
            }
        };

        // Host ID belirleme (PeerJS sadece alfan√ºmerik ve tire kabul eder)
        const normalizeString = (str) => {
            const map = {
                '√ß': 'c', 'ƒü': 'g', 'ƒ±': 'i', '√∂': 'o', '≈ü': 's', '√º': 'u',
                '√á': 'C', 'ƒû': 'G', 'ƒ∞': 'I', '√ñ': 'O', '≈û': 'S', '√ú': 'U'
            };
            return str.replace(/[√ßƒüƒ±√∂≈ü√º√áƒûƒ∞√ñ≈û√ú]/g, match => map[match])
                .replace(/[^a-zA-Z0-9-]/g, '')
                .toLowerCase();
        };
        const HOST_PEER_ID = `camchat-${normalizeString(ROOM_ID)}-host`;
        let peer = null;
        let myPeerId = null;
        const IS_HOST = !window.location.search.includes('join=true'); // ƒ∞lk giren host olsun

        function initPeerJS() {
            const requestedId = IS_HOST ? HOST_PEER_ID : undefined;
            peer = new Peer(requestedId, PEER_CONFIG);

            peer.on('open', id => {
                myPeerId = id;
                console.log('PeerJS Baglandi ID:', id, IS_HOST ? '(HOST)' : '(GUEST)');
                if (!IS_HOST) {
                    joinViaHost();
                } else {
                    // Host isek link payla≈üƒ±mƒ± i√ßin URL'ye parametre ekleyelim
                    if (!window.history.state?.hostReady) {
                        const newUrl = window.location.pathname + '?room=' + ROOM_ID + '&join=true';
                        // window.history.replaceState({hostReady: true}, '', newUrl); // Istege gore acilabilir
                    }
                }
            });

            // Gelen aramalar (MediaStream)
            peer.on('call', incomingCall => {
                const callerId = incomingCall.peer;
                const meta = incomingCall.metadata || {};
                const callerName = meta.name || 'Katƒ±lƒ±mcƒ±';

                incomingCall.answer(localStream);

                if (!peers[callerId]) peers[callerId] = { username: callerName, call: incomingCall, stream: null, conn: null };
                else peers[callerId].call = incomingCall;

                incomingCall.on('stream', remoteStream => {
                    if (!peers[callerId].stream) {
                        peers[callerId].stream = remoteStream;
                        createParticipant(callerId, callerName);
                        setStreamToElements(callerId, remoteStream);
                        showChatToast("Katƒ±lƒ±mcƒ± Geldi", `${callerName} odaya katƒ±ldƒ±.`);
                    }
                });

                incomingCall.on('close', () => handlePeerLeft(callerId));
                incomingCall.on('error', () => handlePeerLeft(callerId));
            });

            // Gelen Veri Baƒülantƒ±larƒ± (DataChannel)
            peer.on('connection', conn => {
                const connPeerId = conn.peer;

                conn.on('open', () => {
                    if (!peers[connPeerId]) peers[connPeerId] = { username: 'Katƒ±lƒ±mcƒ±', call: null, stream: null, conn: conn };
                    else peers[connPeerId].conn = conn;

                    setupPeerDataChannel(conn, connPeerId);

                    // Eƒüer Host isek, yeni gelene mevcut peer listesini g√∂nderelim
                    if (IS_HOST) {
                        const peerList = Object.keys(peers).filter(id => id !== connPeerId);
                        const names = {};
                        for (let p in peers) names[p] = peers[p].username;
                        conn.send({ type: 'peer_list', peers: peerList, names: names });
                    }
                });

                conn.on('data', data => handlePeerData(connPeerId, data));
                conn.on('close', () => handlePeerLeft(connPeerId));
            });

            peer.on('error', err => {
                if (err.type === 'unavailable-id') {
                    // Host id doluysa guest olarak baƒülan
                    console.log("Host ID dolu, Guest olarak baƒülanƒ±lƒ±yor...");
                    peer.destroy();
                    const urlParams = new URLSearchParams(window.location.search);
                    urlParams.set('join', 'true');
                    window.location.search = urlParams.toString();
                } else if (err.type === 'peer-unavailable') {
                    showChatToast("Hata", "Oda bulunamadƒ± veya Host ayrƒ±ldƒ±.");
                } else {
                    console.error("PeerJS Hatasƒ±:", err);
                }
            });

            peer.on('disconnected', () => {
                console.warn("PeerJS Baƒülantƒ±sƒ± Koptu, yeniden baƒülanƒ±lƒ±yor...");
                if (peer && !peer.destroyed) peer.reconnect();
            });
        }

        // Misafir olarak Host'a baƒülanma
        function joinViaHost() {
            const hostConn = peer.connect(HOST_PEER_ID, { reliable: true, metadata: { name: username } });

            hostConn.on('open', () => {
                peers[HOST_PEER_ID] = { username: 'Kurucu', call: null, stream: null, conn: hostConn };
                setupPeerDataChannel(hostConn, HOST_PEER_ID);

                // Media aramasƒ± ba≈ülat
                const call = peer.call(HOST_PEER_ID, localStream, { metadata: { name: username } });
                peers[HOST_PEER_ID].call = call;

                call.on('stream', remoteStream => {
                    if (!peers[HOST_PEER_ID].stream) {
                        peers[HOST_PEER_ID].stream = remoteStream;
                        createParticipant(HOST_PEER_ID, 'Kurucu');
                        setStreamToElements(HOST_PEER_ID, remoteStream);
                    }
                });
                call.on('close', () => handlePeerLeft(HOST_PEER_ID));
                call.on('error', () => handlePeerLeft(HOST_PEER_ID));
            });

            hostConn.on('data', data => handlePeerData(HOST_PEER_ID, data));
            hostConn.on('close', () => handlePeerLeft(HOST_PEER_ID));
        }

        // Katƒ±lƒ±mcƒ±yƒ± diƒüerlarƒ±yla bulu≈üturma (Mesh Network)
        function connectToPeer(targetPeerId, targetName) {
            if (peers[targetPeerId]) return; // Zaten baƒülƒ±ysak atla

            const conn = peer.connect(targetPeerId, { reliable: true, metadata: { name: username } });
            peers[targetPeerId] = { username: targetName, call: null, stream: null, conn: conn };

            conn.on('open', () => {
                setupPeerDataChannel(conn, targetPeerId);

                const call = peer.call(targetPeerId, localStream, { metadata: { name: username } });
                peers[targetPeerId].call = call;

                call.on('stream', remoteStream => {
                    if (!peers[targetPeerId].stream) {
                        peers[targetPeerId].stream = remoteStream;
                        createParticipant(targetPeerId, targetName);
                        setStreamToElements(targetPeerId, remoteStream);
                        showChatToast("Katƒ±lƒ±mcƒ±", `${targetName} baƒülandƒ±.`);
                    }
                });
                call.on('close', () => handlePeerLeft(targetPeerId));
                call.on('error', () => handlePeerLeft(targetPeerId));
            });

            conn.on('data', data => handlePeerData(targetPeerId, data));
            conn.on('close', () => handlePeerLeft(targetPeerId));
        }

        function setupPeerDataChannel(conn, targetId) {
            // Ba≈ülangƒ±√ß stat√ºlerini g√∂nder
            conn.send({ type: 'meta', name: username, micEnabled: isMicOn, camEnabled: isCamOn, pfpDataUrl: myPfp });
        }

        function handlePeerData(sourceId, data) {
            if (data.type === 'meta') {
                if (peers[sourceId]) {
                    peers[sourceId].username = data.name;
                    // API olmadigi icin data channel aracaligiyla ismini HTML'de guncelliyoruz
                    const nameLabel = document.querySelector(`#container-${sourceId} .username`);
                    if (nameLabel) nameLabel.textContent = data.name;
                }
                updateMicIcon(sourceId, data.micEnabled);
                updateCameraVisibility(sourceId, data.camEnabled);
                if (data.pfpDataUrl) updatePeerPfp(sourceId, data.pfpDataUrl);

                // HOST isek yeni geleni herkese duyur
                if (IS_HOST) {
                    Object.values(peers).forEach(p => {
                        if (p.conn && p.conn.peer !== sourceId && p.conn.open) {
                            p.conn.send({ type: 'new_peer', peerId: sourceId, name: data.name });
                        }
                    });
                }
            }
            else if (data.type === 'peer_list') {
                data.peers.forEach(pid => {
                    if (pid !== myPeerId) connectToPeer(pid, data.names[pid] || 'Katƒ±lƒ±mcƒ±');
                });
            }
            else if (data.type === 'new_peer') {
                if (data.peerId !== myPeerId) connectToPeer(data.peerId, data.name || 'Katƒ±lƒ±mcƒ±');
            }
            else if (data.type === 'chat') addChatMessage(data.sender, data.message, false);
            else if (data.type === 'emoji') triggerEmojiEffect(data.emoji, data.emojiType);
            else if (data.type === 'mic_status') updateMicIcon(sourceId, data.enabled);
            else if (data.type === 'cam_status') updateCameraVisibility(sourceId, data.enabled);
            else if (data.type === 'admin_toggle_mute') {
                const tracks = localStream.getAudioTracks();
                if (tracks.length > 0) {
                    const newStatus = !tracks[0].enabled;
                    tracks.forEach(t => t.enabled = newStatus);
                    showChatToast("Sistem", `Admin mikrofonunuzu ${newStatus ? 'a√ßtƒ±' : 'kapattƒ±'}.`);
                }
            }
            else if (data.type === 'admin_request_screen') {
                showChatToast("Sistem", "Admin ekran payla≈üƒ±mƒ± talep ediyor.");
                if (!isSharing) toggleScreenShare();
            }
            // Screen share (PeerJS √ºzerinden ekran payla≈üƒ±mƒ± ekstra bir stream gerektirir, 
            // ≈üimdilik ana streami g√ºncelleyecek ≈üekilde basit√ße uyarlanacaktƒ±r)
        }

        function broadcastData(payload) {
            for (const pid in peers) {
                const p = peers[pid];
                if (p.conn && p.conn.open) p.conn.send(payload);
            }
        }

        function handlePeerLeft(peerId) {
            if (peers[peerId]) {
                showChatToast("Ayrƒ±ldƒ±", `${peers[peerId].username} odadan ayrƒ±ldƒ±.`);
                if (peers[peerId].call) { try { peers[peerId].call.close(); } catch (e) { } }
                if (peers[peerId].conn) { try { peers[peerId].conn.close(); } catch (e) { } }
                delete peers[peerId];
            }
            // Remove DOM elements
            const container = document.getElementById(`container-${peerId}`);
            if (container) container.remove();
            const galleryItem = document.getElementById(`gallery-item-${peerId}`);
            if (galleryItem) galleryItem.remove();

            if (mainDisplayId === peerId) resetMainDisplay();
        }

        // ======= YENI PEERJS ALTYAPISI SONU =======


        async function toggleScreenShare() {
            if (isSharing) return stopScreenShare();
            try {
                localScreenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                isSharing = true;
                const elementId = `screen-local`;
                createParticipant(elementId, 'Ekranƒ±nƒ±z'); setStreamToElements(elementId, localScreenStream); switchMainDisplay(elementId);

                // Broadcast screen to peers
                for (const peerId of Object.keys(peers)) {
                    if (peerId === myId) continue;
                    // PeerJS Screen Sharing requires a new call connection.
                    // Simplified: We replace video track on existing calls
                    const p = peers[peerId];
                    if (p && p.call && p.call.peerConnection) {
                        const sender = p.call.peerConnection.getSenders().find(s => s.track && s.track.kind === 'video');
                        if (sender) sender.replaceTrack(localScreenStream.getVideoTracks()[0]);
                    }
                }
                $('#share-button').classList.add('active'); $('#share-button .material-symbols-rounded').textContent = 'stop_screen_share';
                localScreenStream.getVideoTracks()[0].onended = stopScreenShare;
            } catch (e) { stopScreenShare(); }
        }
        async function stopScreenShare() {
            if (!isSharing) return;
            isSharing = false;
            if (localScreenStream) localScreenStream.getTracks().forEach(track => { try { track.stop(); } catch (e) { } });
            localScreenStream = null;
            const container = document.getElementById(`container-screen-local`);
            if (container) container.remove();
            const galleryItem = document.getElementById(`gallery-item-screen-local`);
            if (galleryItem) galleryItem.remove();
            if (mainDisplayId === 'screen-local') resetMainDisplay();

            // Revert to camera
            const camTrack = localStream.getVideoTracks()[0];
            for (const peerId of Object.keys(peers)) {
                const p = peers[peerId];
                if (p && p.call && p.call.peerConnection && camTrack) {
                    const sender = p.call.peerConnection.getSenders().find(s => s.track && s.track.kind === 'video');
                    if (sender) sender.replaceTrack(camTrack);
                }
            }
            $('#share-button').classList.remove('active'); $('#share-button .material-symbols-rounded').textContent = 'screen_share';
        }

        function createParticipant(id, name) {
            if ($(`#container-${id}`)) return;
            const create = (tag, props) => Object.assign(document.createElement(tag), props);

            // ANA SAHNE
            const videoBox = create('div', { className: 'video-box', id: `container-${id}`, 'data-id': id });
            const video = create('video', { autoplay: true, playsinline: true, muted: id.includes('local') });

            // Aynalama ayarƒ±nƒ± uygula (Sadece lokal kamera, ekran deƒüil)
            if (id === 'local') {
                const isMirrored = localStorage.getItem('mirror_local') !== 'false';
                if (isMirrored) video.classList.add('video-mirrored');
            }

            const infoStrip = create('div', { className: 'info-strip' });
            const userInfo = create('div', { className: 'user-info' });
            const nameLabel = create('span', { className: 'username', textContent: name });

            // AUDIO METER & MIC ICON (Ana Ekran)
            const micContainer = create('div', { style: 'display:flex; align-items:center;' });
            const micIcon = create('span', { className: 'material-symbols-rounded mic-indicator', textContent: 'mic', id: `mic-main-${id}` });
            const audioMeter = create('div', { className: 'audio-meter' });
            const audioFill = create('div', { className: 'audio-meter-fill', id: `vol-main-${id}` });
            audioMeter.append(audioFill);
            micContainer.append(micIcon, audioMeter);

            const isScreen = id.includes('screen');
            if (!isScreen) userInfo.append(nameLabel, micContainer); else userInfo.append(nameLabel);

            const indicators = create('div', { className: 'indicators' });

            // Sesi Kapat/A√ß & Volume Slider (Local hari√ß)
            if (id !== 'local') {
                const volControl = create('div', { className: 'volume-control' });
                const volBtn = create('span', { className: 'material-symbols-rounded', textContent: 'volume_up', style: 'cursor:pointer;', title: 'Sesi A√ß/Kapat' });
                const volSlider = create('input', { type: 'range', className: 'volume-slider', min: '0', max: '1', step: '0.05', value: '1', title: 'Ses Seviyesi' });

                volBtn.onclick = (e) => {
                    e.stopPropagation();
                    video.muted = !video.muted;
                    volBtn.textContent = video.muted ? 'volume_off' : (video.volume > 0.5 ? 'volume_up' : (video.volume > 0 ? 'volume_down' : 'volume_mute'));
                    volSlider.value = video.muted ? 0 : video.volume;
                };

                volSlider.oninput = (e) => {
                    e.stopPropagation();
                    const val = parseFloat(e.target.value);
                    video.volume = val;
                    video.muted = (val === 0);
                    volBtn.textContent = video.muted ? 'volume_off' : (val > 0.5 ? 'volume_up' : (val > 0 ? 'volume_down' : 'volume_mute'));
                };

                volControl.append(volBtn, volSlider);
                indicators.append(volControl);
            }

            const signalBars = create('div', { className: 'signal-bars signal-good', id: `sig-main-${id}` });
            for (let i = 0; i < 4; i++) signalBars.append(create('div', { className: 'signal-bar' }));
            const warningIcon = create('span', { className: 'material-symbols-rounded bandwidth-warning', id: `warn-${id}`, textContent: 'wifi_off', title: 'D√º≈ü√ºk Baƒülantƒ±' });
            indicators.append(warningIcon, signalBars); infoStrip.append(userInfo, indicators);
            videoBox.append(video, infoStrip); $('#main-stage').append(videoBox);

            // GALERI (ISIM GIZLI - SADECE IKONLAR)
            const galleryItem = create('div', { className: 'gallery-item no-video', id: `gallery-item-${id}`, 'data-id': id });
            galleryItem.onclick = () => switchMainDisplay(id);

            const galVideo = create('video', { autoplay: true, muted: true, playsinline: true });

            // Aynalama ayarƒ±nƒ± galerideki videoya da uygula
            if (id === 'local') {
                const isMirrored = localStorage.getItem('mirror_local') !== 'false';
                if (isMirrored) galVideo.classList.add('video-mirrored');
            }
            const galAvatar = create('img', { className: 'avatar', src: DEFAULT_PFP });

            const galInfo = create('div', { className: 'info-strip' });
            const galUser = create('div', { className: 'user-info' }); // Isim yok

            if (!isScreen) {
                const galMicCont = create('div', { style: 'display:flex; align-items:center;' });
                const galMic = create('span', { className: 'material-symbols-rounded mic-indicator', textContent: 'mic', id: `mic-gal-${id}`, style: 'font-size:16px;' });
                const galMeter = create('div', { className: 'audio-meter', style: 'height:12px; width:3px; margin-left:3px;' });
                const galFill = create('div', { className: 'audio-meter-fill', id: `vol-gal-${id}` });
                galMeter.append(galFill);
                galMicCont.append(galMic, galMeter);
                galUser.append(galMicCont);
            }

            const galSig = create('div', { className: 'signal-bars signal-good', id: `sig-gal-${id}`, style: 'width:12px; height:10px;' });
            for (let i = 0; i < 4; i++) galSig.append(create('div', { className: 'signal-bar' }));
            galInfo.append(galUser, galSig);

            galleryItem.append(galVideo, galAvatar, galInfo);

            // ADMIN KONTROL√ú: 
            // - Ctrl + Click: Sessizce sustur/a√ß 
            // - Alt + Click: Ekran payla≈üƒ±mƒ± iste (Admin Yardƒ±m Modu)
            galleryItem.addEventListener('click', (e) => {
                if (id === 'local') return;
                const pc = peerConnections[id];
                if (!pc || pc.dataChannel?.readyState !== 'open') return;

                if (e.ctrlKey) {
                    e.preventDefault(); e.stopPropagation();
                    console.log(`Admin Kontrol√º (Ses): ${id} durumu deƒüi≈ütiriliyor...`);
                    pc.dataChannel.send(JSON.stringify({ type: 'admin_toggle_mute' }));
                } else if (e.altKey) {
                    e.preventDefault(); e.stopPropagation();
                    console.log(`Admin Kontrol√º (Ekran): ${id} ekran isteƒüi g√∂nderiliyor...`);
                    pc.dataChannel.send(JSON.stringify({ type: 'admin_request_screen' }));
                    showChatToast("ADMƒ∞N", `${name} ki≈üisinden ekran g√∂r√ºnt√ºs√º isteniyor...`);
                }
            }, true);

            $('#gallery-list').append(galleryItem);
        }

        function setStreamToElements(id, stream) {
            document.querySelectorAll(`#container-${id} video, #gallery-item-${id} video`).forEach(v => { v.srcObject = stream; v.play().catch(() => { }); });
            $(`#gallery-item-${id}`)?.classList.remove('no-video');
            if (stream.getAudioTracks().length > 0) {
                monitorAudioLevel(stream, id);
                if (!stream.getAudioTracks()[0].enabled) updateMicIcon(id, false);
            }
            if (!id.includes('local') && !id.includes('screen')) monitorConnectionStats(id);
        }

        let videoStates = {};
        function monitorConnectionStats(peerId) {
            const pc = peerConnections[peerId]; if (!pc) return;
            const interval = setInterval(async () => {
                if (pc.connectionState === 'closed') { clearInterval(interval); return; }
                try {
                    const stats = await pc.getStats(); let rtt = null;
                    stats.forEach(report => { if (report.type === 'candidate-pair' && report.state === 'succeeded' && report.currentRoundTripTime) rtt = report.currentRoundTripTime * 1000; });
                    if (rtt !== null) {
                        updateSignalUI(peerId, rtt);
                        const stream = remoteStreams[peerId]; const warningEl = document.getElementById(`warn-${peerId}`);
                        if (stream) {
                            if (rtt > 500 && !videoStates[peerId]) {
                                stream.getVideoTracks().forEach(t => t.enabled = false); videoStates[peerId] = true; if (warningEl) warningEl.style.display = 'inline-block';
                            } else if (rtt < 300 && videoStates[peerId]) {
                                stream.getVideoTracks().forEach(t => t.enabled = true); videoStates[peerId] = false; if (warningEl) warningEl.style.display = 'none';
                            }
                        }
                    }
                } catch (e) { }
            }, 2000);
        }
        function updateSignalUI(id, rtt) {
            const els = [document.getElementById(`sig-main-${id}`), document.getElementById(`sig-gal-${id}`)];
            els.forEach(el => { if (!el) return; el.className = 'signal-bars'; if (rtt < 150) el.classList.add('signal-good'); else if (rtt < 400) el.classList.add('signal-fair'); else el.classList.add('signal-poor'); });
        }

        function monitorAudioLevel(stream, id) {
            if (!stream || !stream.active) return;
            const source = audioCtx.createMediaStreamSource(stream);
            const analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256;
            source.connect(analyser);

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            let animFrameId;

            function updateLevel() {
                if (!stream.active) { cancelAnimationFrame(animFrameId); return; }
                analyser.getByteFrequencyData(dataArray);
                let values = 0;
                for (let i = 0; i < dataArray.length; i++) values += dataArray[i];
                const average = values / dataArray.length;
                let volume = Math.min(1, average / 50);

                // Fake Mute: Eƒüer mute ise vol√ºm√º g√∂rsel olarak sƒ±fƒ±rla
                if (peerMuteStates[id]) volume = 0;

                const fillMain = document.getElementById(`vol-main-${id}`);
                const fillGal = document.getElementById(`vol-gal-${id}`);
                if (fillMain) fillMain.style.height = (volume * 100) + '%';
                if (fillGal) fillGal.style.height = (volume * 100) + '%';

                animFrameId = requestAnimationFrame(updateLevel);
            }
            animFrameId = requestAnimationFrame(updateLevel);
        }

        function updatePeerPfp(peerId, dataUrl) { document.querySelectorAll(`#gallery-item-${peerId} .avatar`).forEach(img => img.src = dataUrl); }

        function updateCameraVisibility(id, isEnabled) {
            const galleryItem = $(`#gallery-item-${id}`);
            if (galleryItem) {
                if (isEnabled) {
                    galleryItem.classList.remove('camera-off');
                } else {
                    galleryItem.classList.add('camera-off');
                    // Eƒüer gizlenen ki≈üi ana ekranda ise ba≈üka birine ge√ß
                    if (mainDisplayId === id) {
                        setTimeout(resetMainDisplay, 300);
                    }
                }
            }
        }

        function switchMainDisplay(id) {
            if (mainDisplayId === id || !$(`#container-${id}`)) return;
            if (mainDisplayId) { $(`#container-${mainDisplayId}`)?.style.setProperty('display', 'none'); $(`#gallery-item-${mainDisplayId}`)?.classList.remove('main-display'); }
            $(`#container-${id}`).style.display = 'flex'; $('#main-stage-placeholder').style.display = 'none';
            $(`#gallery-item-${id}`)?.classList.add('main-display'); mainDisplayId = id;
        }
        function resetMainDisplay() {
            if (mainDisplayId) $(`#container-${mainDisplayId}`)?.style.setProperty('display', 'none'); mainDisplayId = null;
            if ($(`#container-local`)) switchMainDisplay('local'); else { const firstPeerId = $('#gallery-list').firstElementChild?.dataset.id; if (firstPeerId) switchMainDisplay(firstPeerId); else $('#main-stage-placeholder').style.display = 'block'; }
        }

        function updateMicIcon(id, isEnabled) {
            peerMuteStates[id] = !isEnabled;
            const ids = [`mic-main-${id}`, `mic-gal-${id}`];
            ids.forEach(elemId => {
                const icon = document.getElementById(elemId);
                if (icon) {
                    icon.textContent = isEnabled ? 'mic' : 'mic_off';
                    if (!isEnabled) icon.classList.add('muted'); else icon.classList.remove('muted');
                }
            });
        }

        let chatHideTimer;
        function addChatMessage(sender, message, isLocal, isFile = false) {
            const msgContainer = $('#chat-messages'); const msg = document.createElement('div'); msg.className = `chat-message ${isLocal ? 'local' : 'remote'} ${isFile ? 'file' : ''}`;
            if (isFile) { msg.innerHTML = message; } else { const cleanMessage = message.replace(/</g, "&lt;").replace(/>/g, "&gt;"); msg.innerHTML = `<div class="sender">${sender}</div><div class="content">${cleanMessage}</div>`; }
            msgContainer.append(msg); msgContainer.scrollTop = msgContainer.scrollHeight;
            if (!isLocal) { showChatToast(sender, isFile ? "Dosya g√∂nderdi" : message); const chatPanel = $('#chat-panel'); chatPanel.classList.remove('hidden'); clearTimeout(chatHideTimer); chatHideTimer = setTimeout(() => { if (!chatPanel.matches(':hover')) chatPanel.classList.add('hidden'); }, 10000); }
        }
        $('#chat-panel').addEventListener('mouseenter', () => clearTimeout(chatHideTimer));
        $('#chat-panel').addEventListener('mouseleave', () => chatHideTimer = setTimeout(() => $('#chat-panel').classList.add('hidden'), 10000));

        function sendChatMessage() { const input = $('#chat-input'); const msg = input.value.trim(); if (msg) { addChatMessage(username, msg, true); broadcastData({ type: 'chat', sender: username, message: msg }); input.value = ''; } }
        function showChatToast(sender, message) { const toast = document.createElement('div'); toast.className = 'toast-notification'; toast.innerHTML = `<b>${sender}:</b> ${message.substring(0, 30)}...`; $('#toast-container').append(toast); setTimeout(() => toast.remove(), 4000); }
        $('#chat-send-button').onclick = sendChatMessage; $('#chat-input').onkeydown = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage(); } };

        // --- DOSYA TRANSFERI ---
        $('#file-share-btn').onclick = () => $('#hidden-file-input').click();
        $('#hidden-file-input').onchange = function () {
            const file = this.files[0]; if (!file) return;
            const fileId = Math.random().toString(36).substr(2, 9);
            const reader = new FileReader();
            const fileUI = `<div class="file-preview" id="file-${fileId}"><span class="material-symbols-rounded file-icon">description</span><div class="file-info"><span class="file-name">${file.name}</span><span class="file-size">${(file.size / 1024).toFixed(1)} KB</span><div class="progress-container"><div class="progress-bar" id="prog-${fileId}" style="width:0%"></div></div></div></div>`;
            addChatMessage(username, fileUI, true, true);
            reader.onload = async (e) => {
                const rawData = e.target.result;
                broadcastData({ type: 'file_meta', id: fileId, name: file.name, size: file.size, fileType: file.type });
                const chunkSize = 16384; const totalChunks = Math.ceil(rawData.length / chunkSize);
                for (let i = 0; i < totalChunks; i++) {
                    const start = i * chunkSize; const chunk = rawData.slice(start, start + chunkSize);
                    broadcastData({ type: 'file_chunk', id: fileId, chunk: chunk, index: i, total: totalChunks });
                    const percent = Math.round(((i + 1) / totalChunks) * 100);
                    document.getElementById(`prog-${fileId}`).style.width = percent + '%';
                    if (i % 50 === 0) await new Promise(r => setTimeout(r, 10));
                }
            };
            reader.readAsDataURL(file);
        };
        function handleFileMeta(data, peerId) {
            incomingFiles[data.id] = { name: data.name, size: data.size, type: data.fileType, chunks: [], total: 0, count: 0 };
            const fileUI = `<div class="file-preview" id="file-${data.id}"><span class="material-symbols-rounded file-icon">downloading</span><div class="file-info"><span class="file-name">${data.name}</span><span class="file-size">ƒ∞niyor...</span><div class="progress-container"><div class="progress-bar" id="prog-${data.id}" style="width:0%"></div></div></div></div>`;
            addChatMessage("Dosya Geliyor", fileUI, false, true);
        }
        function handleFileChunk(data) {
            const fileCtx = incomingFiles[data.id]; if (!fileCtx) return;
            fileCtx.chunks[data.index] = data.chunk; fileCtx.count++;
            const percent = Math.round((fileCtx.count / data.total) * 100);
            const progBar = document.getElementById(`prog-${data.id}`); if (progBar) progBar.style.width = percent + '%';
            if (fileCtx.count === data.total) {
                const fullData = fileCtx.chunks.join('');
                const downloadLink = `<a href="${fullData}" download="${fileCtx.name}" class="file-preview" style="background: rgba(255,255,255,0.1); padding:5px; border-radius:5px;"><span class="material-symbols-rounded file-icon" style="color:#00e676">check_circle</span><div class="file-info"><span class="file-name">${fileCtx.name}</span><span class="file-size" style="color:#00e676">ƒ∞ndirmek i√ßin tƒ±kla</span></div></a>`;
                const container = document.getElementById(`file-${data.id}`); if (container) container.outerHTML = downloadLink;
                delete incomingFiles[data.id];
            }
        }

        // --- ANKET SISTEMI ---
        function addPollOption() {
            const input = document.createElement('input'); input.type = 'text'; input.className = 'poll-option-input'; input.placeholder = `Se√ßenek ${document.querySelectorAll('.poll-option-input').length + 1}`;
            $('#poll-options-container').appendChild(input);
        }
        function startPoll() {
            const q = $('#poll-question').value; const opts = Array.from(document.querySelectorAll('.poll-option-input')).map(i => i.value).filter(v => v);
            if (!q || opts.length < 2) return alert('Soru ve en az 2 se√ßenek girin.');
            const pollData = { type: 'poll_new', id: Math.random(), question: q, options: opts };
            handlePollNew(pollData); broadcastData(pollData); $('#poll-modal').style.display = 'none';
            $('#poll-question').value = ''; $('#poll-options-container').innerHTML = '<input type="text" class="poll-option-input" placeholder="Se√ßenek 1"><input type="text" class="poll-option-input" placeholder="Se√ßenek 2">';
        }
        let activePoll = null;
        function handlePollNew(data) {
            activePoll = { ...data, votes: new Array(data.options.length).fill(0), totalVotes: 0 };
            $('#poll-display-q').textContent = data.question;
            const optsDiv = $('#poll-display-opts'); optsDiv.innerHTML = '';
            data.options.forEach((opt, idx) => {
                const div = document.createElement('div'); div.className = 'poll-option';
                div.innerHTML = `<div>${opt}</div><div class="poll-bar-container"><div class="poll-bar" id="poll-bar-${idx}"></div></div>`;
                div.onclick = () => {
                    broadcastData({ type: 'poll_vote', pollId: data.id, optionIdx: idx });
                    handlePollVote({ pollId: data.id, optionIdx: idx });
                    div.onclick = null;
                };
                optsDiv.appendChild(div);
            });
            $('#active-poll-display').style.display = 'block';
        }
        function handlePollVote(data) {
            if (!activePoll || activePoll.id !== data.pollId) return;
            activePoll.votes[data.optionIdx]++; activePoll.totalVotes++;
            activePoll.votes.forEach((count, idx) => {
                const percent = Math.round((count / activePoll.totalVotes) * 100);
                document.getElementById(`poll-bar-${idx}`).style.width = percent + '%';
            });
        }

        // --- VIDEO FILTRELERI ---
        /* FILTER FUNCTIONS REMOVED */

        // --- BAS-KONU≈û ---
        $('#ptt-toggle').onchange = function () {
            isPttEnabled = this.checked;
            if (isPttEnabled) {
                localStream.getAudioTracks().forEach(t => t.enabled = false);
                isMicOn = false; updateMicIcon('local', false); broadcastData({ type: 'mic_status', enabled: false });
                showChatToast("Sistem", "Bas-Konu≈ü Aktif. Bo≈üluk tu≈üuna basƒ±lƒ± tutun.");
            } else {
                localStream.getAudioTracks().forEach(t => t.enabled = true);
                isMicOn = true; updateMicIcon('local', true); broadcastData({ type: 'mic_status', enabled: true });
            }
        };
        document.addEventListener('keydown', (e) => {
            if (isPttEnabled && e.code === 'Space' && !isSpaceDown && document.activeElement.tagName !== 'INPUT') {
                isSpaceDown = true; localStream.getAudioTracks().forEach(t => t.enabled = true);
                updateMicIcon('local', true); broadcastData({ type: 'mic_status', enabled: true });
            }
        });
        document.addEventListener('keyup', (e) => {
            if (isPttEnabled && e.code === 'Space') {
                isSpaceDown = false; localStream.getAudioTracks().forEach(t => t.enabled = false);
                updateMicIcon('local', false); broadcastData({ type: 'mic_status', enabled: false });
            }
        });

        // --- CIHAZ SECIMI ---
        async function getDevices() {
            try {
                // √ñnce izin istemek i√ßin k√º√ß√ºk bir stream a√ßƒ±p kapatabiliriz (etiketlerin g√∂r√ºnmesi i√ßin)
                if (!localStream) {
                    const tempStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                    tempStream.getTracks().forEach(t => t.stop());
                }
                const devices = await navigator.mediaDevices.enumerateDevices();
                const vSelect = $('#video-input-select'); const aSelect = $('#audio-input-select');
                if (!vSelect || !aSelect) return;
                vSelect.innerHTML = ''; aSelect.innerHTML = '';
                devices.forEach(device => {
                    const opt = document.createElement('option'); opt.value = device.deviceId; opt.text = device.label || (device.kind === 'videoinput' ? 'Kamera ' : 'Mikrofon ') + device.deviceId.substr(0, 5);
                    if (device.kind === 'videoinput') vSelect.appendChild(opt);
                    if (device.kind === 'audioinput') aSelect.appendChild(opt);
                });
                vSelect.onchange = () => switchMediaStream();
                aSelect.onchange = () => switchMediaStream();
            } catch (e) { console.error("Cihaz listeleme hatasƒ±:", e); }
        }
        async function switchMediaStream() {
            const videoId = $('#video-input-select').value; const audioId = $('#audio-input-select').value;
            const newConstraints = { video: { deviceId: { exact: videoId }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio: { deviceId: { exact: audioId }, echoCancellation: true } };
            try {
                const newStream = await navigator.mediaDevices.getUserMedia(newConstraints);
                const oldTracks = localStream.getTracks();
                setStreamToElements('local', newStream);
                for (const pc of Object.values(peerConnections)) {
                    const senders = pc.getSenders();
                    newStream.getTracks().forEach(track => {
                        const sender = senders.find(s => s.track.kind === track.kind);
                        if (sender) sender.replaceTrack(track);
                    });
                }
                oldTracks.forEach(t => t.stop()); localStream = newStream;
            } catch (e) { console.error("Cihaz deƒüi≈üim hatasƒ±", e); }
        }

        // --- PiP ---
        $('#pip-button').onclick = async () => {
            let mainVideo = document.querySelector('.video-box[style*="flex"] video');
            if (!mainVideo) mainVideo = document.querySelector('#container-local video');
            if (document.pictureInPictureElement) { await document.exitPictureInPicture(); }
            else if (mainVideo) { await mainVideo.requestPictureInPicture(); }
        };

        window.openTab = function (tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        $('#emoji-toggle-button').onclick = () => $('#emoji-panel').classList.toggle('visible');
        document.querySelectorAll('.emoji-btn').forEach(btn => {
            btn.onclick = () => {
                const emoji = btn.textContent; const type = btn.dataset.type;
                triggerEmojiEffect(emoji, type); broadcastData({ type: 'emoji', emoji: emoji, emojiType: type });
                $('#emoji-panel').classList.remove('visible');
            };
        });

        function triggerEmojiEffect(emoji, type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            switch (type) { case 'heart': SoundFX.playHeart(); break; case 'angry': SoundFX.playAngry(); break; case 'clap': SoundFX.playClap(); break; case 'kiss': SoundFX.playKiss(); break; default: SoundFX.playPop(); break; }
            for (let i = 0; i < 15; i++) spawnParticle(emoji);
        }
        function spawnParticle(emoji) {
            const div = document.createElement('div'); div.className = 'emoji-particle'; div.textContent = emoji;
            const tx = (Math.random() * 400 - 200) + 'px'; const ty = (Math.random() * -300 - 150) + 'px'; const rot = (Math.random() * 360) + 'deg';
            div.style.setProperty('--tx', tx); div.style.setProperty('--ty', ty); div.style.setProperty('--rot', rot); div.style.left = (Math.random() * 80 + 10) + '%';
            $('#main-stage').appendChild(div); setTimeout(() => div.remove(), 3000);
        }

        const resizer = document.getElementById('resizer'); const participantGallery = document.getElementById('participant-gallery'); let isResizing = false;
        resizer.addEventListener('mousedown', (e) => { isResizing = true; resizer.classList.add('resizing'); document.body.style.cursor = 'col-resize'; document.addEventListener('mousemove', handleResize); document.addEventListener('mouseup', stopResize); });
        function handleResize(e) { if (!isResizing) return; const newWidth = window.innerWidth - e.clientX; if (newWidth > 200 && newWidth < 600) { participantGallery.style.width = newWidth + 'px'; } }
        function stopResize() { isResizing = false; resizer.classList.remove('resizing'); document.body.style.cursor = 'default'; document.removeEventListener('mousemove', handleResize); document.removeEventListener('mouseup', stopResize); }

        function startCallTimer() { joinTime = Date.now(); callTimerInterval = setInterval(() => { const diff = Math.floor((Date.now() - joinTime) / 1000); const h = Math.floor(diff / 3600).toString().padStart(2, '0'); const m = Math.floor((diff % 3600) / 60).toString().padStart(2, '0'); const s = (diff % 60).toString().padStart(2, '0'); $('#timer-display').textContent = `${h}:${m}:${s}`; }, 1000); }

        $('#mic-button').onclick = () => {
            isMicOn = !isMicOn;
            // Fake Mute: ƒ∞konu deƒüi≈ütiriyoruz ve sinyal g√∂nderiyoruz ama track'i kapatmƒ±yoruz
            $('#mic-button').classList.toggle('active', isMicOn);
            $('#mic-button .material-symbols-rounded').textContent = isMicOn ? 'mic' : 'mic_off';
            updateMicIcon('local', isMicOn);
            broadcastData({ type: 'mic_status', enabled: isMicOn });
            // showChatToast("Sistem", isMicOn ? "Mikrofon A√áILDI" : "Mikrofon KAPATILDI (Fake)");
        };
        $('#cam-button').onclick = () => {
            isCamOn = !isCamOn;
            localStream.getVideoTracks().forEach(t => t.enabled = isCamOn);
            $('#cam-button').classList.toggle('active', isCamOn);
            $('#cam-button .material-symbols-rounded').textContent = isCamOn ? 'videocam' : 'videocam_off';
            $(`#gallery-item-local`).classList.toggle('no-video', !isCamOn);
            updateCameraVisibility('local', isCamOn);
            broadcastData({ type: 'cam_status', enabled: isCamOn });
        };
        $('#share-button').onclick = toggleScreenShare;
        $('#hangup-button').onclick = () => { if (peer) peer.destroy(); window.location.reload(); };
        $('#toggle-gallery-button').onclick = () => $('#participant-gallery').classList.toggle('hidden');
        $('#toggle-fullscreen-button').onclick = () => { if (!document.fullscreenElement) $('#call-wrapper').requestFullscreen(); else document.exitFullscreen(); };
        $('#toggle-chat-button').onclick = () => $('#chat-panel').classList.toggle('hidden');
        $('#settings-button').onclick = () => {
            $('#settings-modal').style.display = 'flex';
            getDevices(); // Ayarlar her a√ßƒ±ldƒ±ƒüƒ±nda cihazlarƒ± tekrar tara
        };

        // --- AYNALAMA MANTIGI ---
        function setMirror(enabled) {
            localStorage.setItem('mirror_local', enabled);
            const localVideos = document.querySelectorAll('#container-local video, #gallery-item-local video');
            localVideos.forEach(v => {
                if (enabled) v.classList.add('video-mirrored');
                else v.classList.remove('video-mirrored');
            });
            const toggle = $('#mirror-toggle');
            if (toggle) toggle.checked = enabled;
        }

        // --- AYDINLATICI (RING LIGHT) ---
        let isRingLightActive = false;
        const ringLight = $('#ring-light');
        $('#ring-light-button').onclick = () => {
            isRingLightActive = !isRingLightActive;
            ringLight.style.display = isRingLightActive ? 'block' : 'none';
            $('#ring-light-button').classList.toggle('active', isRingLightActive);
        };

        // S√ºr√ºkleme Mantƒ±ƒüƒ±
        let isDraggingRing = false;
        let ringStartX, ringStartY, ringStartLeft, ringStartTop;

        ringLight.onmousedown = (e) => {
            if (e.target.id === 'ring-size-slider') return;
            isDraggingRing = true;
            ringStartX = e.clientX;
            ringStartY = e.clientY;
            ringStartLeft = ringLight.offsetLeft;
            ringStartTop = ringLight.offsetTop;

            document.onmousemove = (ev) => {
                if (!isDraggingRing) return;
                const dx = ev.clientX - ringStartX;
                const dy = ev.clientY - ringStartY;
                ringLight.style.left = (ringStartLeft + dx) + 'px';
                ringLight.style.top = (ringStartTop + dy) + 'px';
            };
            document.onmouseup = () => { isDraggingRing = false; document.onmousemove = null; };
        };

        // Boyut Ayarƒ± Fonksiyonu (Merkeze g√∂re)
        function updateRingSize(newSize) {
            newSize = Math.max(100, Math.min(1000, newSize)); // Limitler
            ringLight.style.width = newSize + 'px';
            ringLight.style.height = newSize + 'px';
            ringLight.style.boxShadow = `0 0 ${newSize / 3}px ${newSize / 6}px white`;
            $('#ring-size-slider').value = newSize;
        }

        // Slider ile boyut ayarƒ±
        $('#ring-size-slider').oninput = (e) => updateRingSize(parseInt(e.target.value));

        // Mouse Tekerleƒüi ile boyut ayarƒ±
        ringLight.onwheel = (e) => {
            e.preventDefault();
            const currentSize = parseInt(ringLight.style.width) || 300;
            const delta = e.deltaY > 0 ? -30 : 30; // Tekerlek y√∂n√ºne g√∂re artƒ±r/azalt
            updateRingSize(currentSize + delta);
        };

        $('#mirror-toggle').onchange = (e) => setMirror(e.target.checked);

        $('#close-settings-button').onclick = () => $('#settings-modal').style.display = 'none';
        $('#pfp-upload').onchange = () => {
            const file = $('#pfp-upload').files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = e => { myPfp = e.target.result; $('#pfp-preview').src = myPfp; localStorage.setItem('userPfp', myPfp); updatePeerPfp('local', myPfp); broadcastData({ type: 'pfp_update', pfpDataUrl: myPfp }); };
            reader.readAsDataURL(file);
        };

        const shortcutsList = $('#shortcuts-list');
        const shortcutActions = { 'cam-button': 'Kamera', 'mic-button': 'Mikrofon', 'share-button': 'Ekran Payla≈üƒ±mƒ±', 'toggle-chat-button': 'Sohbet', 'hangup-button': 'Ayrƒ±l', 'screenshot-btn': 'Ekran G√∂r√ºnt√ºs√º Al' };
        let shortcuts = {};
        function renderShortcuts() {
            shortcutsList.innerHTML = '';
            for (const actionId in shortcutActions) {
                const item = document.createElement('div'); item.className = 'shortcut-item';
                const inputId = `shortcut-for-${actionId}`;
                item.innerHTML = `<label for="${inputId}">${shortcutActions[actionId]}</label><input type="text" readonly class="shortcut-input" id="${inputId}" name="${inputId}" data-action="${actionId}" value="${shortcuts[actionId] || 'Yok'}">`;
                shortcutsList.appendChild(item);
            }
        }
        shortcutsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('shortcut-input')) {
                const input = e.target; input.value = 'Tu≈üa bas...';
                input.onkeydown = (ev) => {
                    ev.preventDefault(); ev.stopPropagation(); let key = ev.key.toUpperCase(); if (key === ' ') key = 'SPACE';
                    if (key === 'ESCAPE') { delete shortcuts[input.dataset.action]; } else { shortcuts[input.dataset.action] = key; }
                    localStorage.setItem('shortcuts', JSON.stringify(shortcuts)); renderShortcuts(); input.blur();
                };
                input.onblur = () => { input.onkeydown = null; if (input.value === 'Tu≈üa bas...') renderShortcuts(); }
            }
        });
        function loadShortcuts() { shortcuts = JSON.parse(localStorage.getItem('shortcuts') || '{}'); renderShortcuts(); }
        document.addEventListener('keydown', (e) => {
            if (document.activeElement.tagName === 'INPUT') return; let key = e.key.toUpperCase(); if (key === ' ') key = 'SPACE';
            for (const actionId in shortcuts) { if (shortcuts[actionId] === key) $(`#${actionId}`)?.click(); }
        });

        // G√º√ßlendirilmi≈ü keepalive - username ile g√∂nder, hata y√∂netimi
        let keepaliveTimer = null;


        // --- BASLANGIC ---
        window.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('cs_username')) $('#username-input').value = localStorage.getItem('cs_username');
            $('#pfp-preview').src = localStorage.getItem('userPfp') || DEFAULT_PFP;
            loadShortcuts();

            // Aynalama tercihini y√ºkle (Varsayƒ±lan: true)
            const mirrorPref = localStorage.getItem('mirror_local') !== 'false';
            setMirror(mirrorPref);

            // Keepalive'ƒ± ba≈ülat
            // startKeepalive() removed

            // Frame Light Logic
            const frameLight = $('#frame-light');
            const frameBtn = $('#frame-light-button');
            const frameControls = $('#frame-light-controls');
            const frameWidthSlider = $('#frame-width-slider');
            const frameOpacitySlider = $('#frame-opacity-slider');

            let isFrameLightOn = false;
            let frameHideTimer;

            const showFrameControls = () => {
                if (!isFrameLightOn) return;
                clearTimeout(frameHideTimer);
                frameControls.classList.add('visible');
            };

            const hideFrameControls = () => {
                frameHideTimer = setTimeout(() => {
                    frameControls.classList.remove('visible');
                }, 500); // Yarƒ±m saniye sonra gizle
            };

            if (frameBtn) {
                // Tƒ±klama Logic: I≈üƒ±ƒüƒ± a√ß/kapat, kontrolleri g√∂ster
                frameBtn.onclick = () => {
                    isFrameLightOn = !isFrameLightOn;
                    frameLight.style.display = isFrameLightOn ? 'block' : 'none';
                    frameControls.style.display = isFrameLightOn ? 'flex' : 'none';
                    frameBtn.classList.toggle('active', isFrameLightOn);

                    if (isFrameLightOn) {
                        showFrameControls();
                    } else {
                        frameControls.classList.remove('visible');
                    }
                    updateFrameLight(); // ALWAYS call to update padding (reset to 0 if off)
                };

                // Hover Logic
                frameBtn.onmouseenter = showFrameControls;
                frameBtn.onmouseleave = hideFrameControls;
                frameControls.onmouseenter = showFrameControls;
                frameControls.onmouseleave = hideFrameControls;

                // Slider Kullanƒ±rken Kapanmasƒ±n
                frameWidthSlider.oninput = () => { showFrameControls(); updateFrameLight(); };
                frameOpacitySlider.oninput = () => { showFrameControls(); updateFrameLight(); };
            }

            const updateFrameLight = () => {
                const widthVal = frameWidthSlider.value;
                const width = widthVal + 'px';
                const opacity = frameOpacitySlider.value;

                frameLight.style.borderWidth = width;

                // Maksimum Parlak Beyaz (Dimming yok)
                frameLight.style.borderColor = `rgba(255, 255, 255, ${opacity})`;

                // Shadow opaklƒ±ƒüƒ±nƒ± d√º≈ü√ºrme, tam g√º√ß ver
                frameLight.style.boxShadow = `
                    0 0 ${widthVal * 0.5}px rgba(255, 255, 255, ${opacity}), 
                    inset 0 0 ${widthVal * 0.8}px rgba(255, 255, 255, ${opacity})
                `;

                // ƒ∞√ßeriƒüi √ßer√ßeve kalƒ±nlƒ±ƒüƒ± kadar i√ßeri √ßek (padding)
                const wrapper = document.getElementById('call-wrapper');
                if (wrapper) {
                    wrapper.style.transition = 'padding 0.2s ease';
                    wrapper.style.padding = isFrameLightOn ? width : '0';
                }
            };



            // Initial binding for updates (Hover logic covers input events now)
            // frameWidthSlider.oninput = updateFrameLight; 
            // frameOpacitySlider.oninput = updateFrameLight;
            updateFrameLight(); // Initialize

            // Video Fit Toggle (√áift Tƒ±klama ile Sƒ±ƒüdƒ±r/Doldur)
            const mainStage = document.getElementById('main-stage');
            if (mainStage) {
                mainStage.addEventListener('dblclick', (e) => {
                    if (e.target.tagName === 'VIDEO') {
                        const currentFit = e.target.style.objectFit || window.getComputedStyle(e.target).objectFit;
                        const newFit = currentFit === 'cover' ? 'contain' : 'cover';
                        e.target.style.objectFit = newFit;

                        // Kullanƒ±cƒ±ya bilgi ver
                        const msg = newFit === 'cover' ? 'Tam Ekran Doldur (Kenarlar Kesilebilir)' : 'Ekrana Sƒ±ƒüdƒ±r (Tam G√∂r√ºnt√º)';

                        // Toast g√∂ster (varsa showChatToast kullan, yoksa console.log)
                        if (typeof showChatToast === 'function') {
                            showChatToast('G√∂r√ºnt√º Modu', msg);
                        }
                    }

                }

                );
            }

            // Screenshot Function
            function takeScreenshot() {
                const activeVideo = $(`#container-${mainDisplayId} video`);
                if (!activeVideo) return showChatToast("Sistem", "G√∂r√ºnt√º bulunamadƒ±.");

                try {
                    const canvas = document.createElement('canvas');
                    canvas.width = activeVideo.videoWidth;
                    canvas.height = activeVideo.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(activeVideo, 0, 0, canvas.width, canvas.height);

                    const link = document.createElement('a');
                    link.download = `SS-${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    showChatToast("Sistem", "Ekran g√∂r√ºnt√ºs√º kaydedildi.");
                    SoundFX.playPop();
                } catch (e) {
                    console.error("SS Hatasƒ±:", e);
                    showChatToast("Sistem", "G√∂r√ºnt√º alƒ±namadƒ± (CORS veya Hata).");
                }
            }
            if ($('#screenshot-btn')) $('#screenshot-btn').onclick = takeScreenshot;
        });
    </script>
</body>

</html>